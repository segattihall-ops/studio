{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the massage directory.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user.",
          "format": "uuid"
        },
        "firstName": {
          "type": "string",
          "description": "The first name of the user."
        },
        "lastName": {
          "type": "string",
          "description": "The last name of the user."
        },
        "email": {
          "type": "string",
          "description": "The email address of the user.",
          "format": "email"
        },
        "phone": {
          "type": "string",
          "description": "The phone number of the user."
        },
        "dateOfBirth": {
          "type": "string",
          "description": "The date of birth of the user.",
          "format": "date"
        },
        "address": {
          "type": "string",
          "description": "The physical address of the user."
        }
      },
      "required": [
        "id",
        "firstName",
        "lastName",
        "email"
      ]
    },
    "Subscription": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Subscription",
      "type": "object",
      "description": "Represents a user's subscription to the massage directory.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the subscription.",
          "format": "uuid"
        },
        "userId": {
          "type": "string",
          "description": "Reference to the User entity."
        },
        "startDate": {
          "type": "string",
          "description": "The start date of the subscription.",
          "format": "date-time"
        },
        "endDate": {
          "type": "string",
          "description": "The end date of the subscription.",
          "format": "date-time"
        },
        "status": {
          "type": "string",
          "description": "The status of the subscription (e.g., active, inactive, cancelled)."
        },
        "planId": {
          "type": "string",
          "description": "Reference to the Plan entity."
        }
      },
      "required": [
        "id",
        "userId",
        "startDate",
        "endDate",
        "status",
        "planId"
      ]
    },
    "Plan": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Plan",
      "type": "object",
      "description": "Represents a subscription plan.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the plan.",
          "format": "uuid"
        },
        "name": {
          "type": "string",
          "description": "The name of the plan (e.g., Basic, Premium)."
        },
        "price": {
          "type": "number",
          "description": "The price of the plan."
        },
        "description": {
          "type": "string",
          "description": "A description of the plan's features and benefits."
        },
        "duration": {
          "type": "string",
          "description": "The duration of the subscription (e.g., Monthly, Annually)"
        }
      },
      "required": [
        "id",
        "name",
        "price",
        "description"
      ]
    },
    "Therapist": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Therapist",
      "type": "object",
      "description": "Represents a therapist in the directory.",
      "properties": {
        "user_id": {
          "type": "string",
          "description": "Unique identifier for the therapist, linked to their auth UID."
        },
        "full_name": {
          "type": "string",
          "description": "The full name of the therapist."
        },
        "email": {
          "type": "string",
          "description": "The email address of the therapist.",
          "format": "email"
        },
        "status": {
          "type": "string",
          "description": "The current status of the therapist's profile (e.g., Pending, Active, Inactive, Rejected)."
        },
        "plan": {
          "type": "string",
          "description": "The ID of the subscription plan."
        },
        "plan_name": {
          "type": "string",
          "description": "The name of the subscription plan."
        },
        "subscription_status": {
          "type": "string",
          "description": "The status of the therapist's subscription (e.g., Active, Canceled)."
        },
        "updated_at": {
          "type": "string",
          "description": "Timestamp of the last profile update.",
          "format": "date-time"
        },
        "slug": {
          "type": "string",
          "description": "URL-friendly identifier for the therapist."
        },
        "phone": {
          "type": "string",
          "description": "Phone number of the therapist."
        },
        "reviewed_at": {
          "type": "string",
          "description": "Timestamp of when the profile was reviewed.",
          "format": "date-time"
        },
        "reviewed_by": {
          "type": "string",
          "description": "UID of the admin who reviewed the profile."
        },
        "rejection_reason": {
          "type": "string",
          "description": "Reason for profile rejection."
        },
        "document_url": {
          "type": "string",
          "description": "URL for the identity document.",
          "format": "uri"
        },
        "card_url": {
          "type": "string",
          "description": "URL for the license/card document.",
          "format": "uri"
        },
        "selfie_url": {
          "type": "string",
          "description": "URL for the selfie image.",
          "format": "uri"
        },
        "signed_term_url": {
          "type": "string",
          "description": "URL for the signed term document.",
          "format": "uri"
        }
      },
      "required": [
        "user_id",
        "full_name",
        "email",
        "status"
      ]
    },
    "Payment": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Payment",
      "type": "object",
      "description": "Represents a single payment transaction.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the payment." },
        "userId": { "type": "string", "description": "The ID of the user who made the payment." },
        "amount": { "type": "number", "description": "The payment amount." },
        "paid_at": { "type": "string", "format": "date-time", "description": "Timestamp of when the payment was made." },
        "status": { "type": "string", "description": "The status of the payment (e.g., succeeded, failed)." }
      },
      "required": ["id", "userId", "amount", "paid_at", "status"]
    },
    "BillingEventLog": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Billing Event Log",
      "type": "object",
      "description": "Logs events from the billing system (e.g., Stripe webhooks).",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the event log." },
        "event_type": { "type": "string", "description": "The type of event (e.g., 'invoice.payment_succeeded')." },
        "payload": { "type": "object", "description": "The full event payload from the provider." },
        "created_at": { "type": "string", "format": "date-time", "description": "Timestamp of when the event was logged." }
      },
      "required": ["id", "event_type", "payload", "created_at"]
    },
    "Settings": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Settings",
      "type": "object",
      "description": "Stores global application settings.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the setting document (e.g., 'stripe')." },
        "stripe_public_key": { "type": "string", "description": "The publishable API key for Stripe." },
        "stripe_secret_key": { "type": "string", "description": "The secret API key for Stripe (stored securely)." }
      },
      "required": ["id"]
    },
    "Article": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Article",
      "type": "object",
      "description": "Represents a blog post or article.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the article." },
        "title": { "type": "string", "description": "The title of the article." },
        "content": { "type": "string", "description": "The main body content of the article." },
        "author_id": { "type": "string", "description": "The ID of the user who wrote the article." },
        "author_name": { "type": "string", "description": "The name of the author." },
        "status": { "type": "string", "enum": ["draft", "review", "published"], "description": "The current status of the article." },
        "published_at": { "type": "string", "format": "date-time", "description": "Timestamp of when the article was published." },
        "created_at": { "type": "string", "format": "date-time", "description": "Timestamp of when the article was created." },
        "updated_at": { "type": "string", "format": "date-time", "description": "Timestamp of the last update." }
      },
      "required": ["id", "title", "author_id", "status", "created_at", "updated_at"]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profiles. Path-based ownership simplifies security rules ensuring only the authenticated user can access their own profile.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/subscriptions/{subscriptionId}",
        "definition": {
          "entityName": "Subscription",
          "schema": {
            "$ref": "#/backend/entities/Subscription"
          },
          "description": "Stores all user subscriptions in a top-level collection for easier admin queries. Each document contains a userId to link back to the user.",
          "params": [
            {
              "name": "subscriptionId",
              "description": "The unique identifier of the subscription."
            }
          ]
        }
      },
      {
        "path": "/plans/{planId}",
        "definition": {
          "entityName": "Plan",
          "schema": {
            "$ref": "#/backend/entities/Plan"
          },
          "description": "Stores subscription plans.  Accessible to all users for viewing available plans. Admin access can be controlled via a separate `/roles_admin/{uid}` document check.",
          "params": [
            {
              "name": "planId",
              "description": "The unique identifier of the plan."
            }
          ]
        }
      },
      {
        "path": "/therapists/{therapistId}",
        "definition": {
          "entityName": "Therapist",
          "schema": {
            "$ref": "#/backend/entities/Therapist"
          },
          "description": "Stores therapist profiles.",
          "params": [
            {
              "name": "therapistId",
              "description": "The unique identifier of the therapist."
            }
          ]
        }
      },
      {
        "path": "/payments/{paymentId}",
        "definition": {
          "entityName": "Payment",
          "schema": { "$ref": "#/backend/entities/Payment" },
          "description": "Stores individual payment records. Typically only accessible by admins or server-side functions.",
          "params": [{ "name": "paymentId", "description": "The unique identifier of the payment." }]
        }
      },
      {
        "path": "/billing_event_logs/{logId}",
        "definition": {
          "entityName": "BillingEventLog",
          "schema": { "$ref": "#/backend/entities/BillingEventLog" },
          "description": "Logs all incoming webhook events from the billing provider. Restricted to admin or server-side access.",
          "params": [{ "name": "logId", "description": "The unique identifier of a log entry." }]
        }
      },
      {
        "path": "/settings/{settingId}",
        "definition": {
          "entityName": "Settings",
          "schema": { "$ref": "#/backend/entities/Settings" },
          "description": "Stores global, non-user-specific settings. Access should be highly restricted.",
          "params": [{ "name": "settingId", "description": "The unique name of the setting document (e.g., 'billing')." }]
        }
      },
      {
        "path": "/articles/{articleId}",
        "definition": {
          "entityName": "Article",
          "schema": { "$ref": "#/backend/entities/Article" },
          "description": "Stores articles and blog posts. Accessible by admins for content management.",
          "params": [{ "name": "articleId", "description": "The unique identifier of the article." }]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to support a massage directory with user subscriptions. It prioritizes authorization independence by structuring data to avoid hierarchical `get()` calls in security rules. This is achieved by storing user-related data under their respective user IDs, enabling simple, path-based security rules.\n\nThe `/users/{userId}` collection stores user profiles. Subscriptions have been moved to a top-level `/subscriptions/{subscriptionId}` collection to allow for efficient admin-level queries across all users, while still containing a `userId` field for data linkage. Plans are in `/plans/{planId}`. The `/therapists/{therapistId}` collection stores public profiles. New top-level collections for `/payments`, `/billing_event_logs`, `/settings`, and `/articles` have been added to support a robust billing and content management integration, keeping sensitive financial data, configurations, and content separate and secure.\n\nAuthorization Independence: The structure places user-owned data under `/users/{userId}`, allowing rules to directly verify `request.auth.uid == userId`. Admin-level `list` operations on `/subscriptions` are now possible without complex queries.\n\nQAPs (Rules are not Filters):  The segregation of data into appropriate top-level or user-scoped collections allows for secure `list` operations. For example, administrators can `list` all users in the `/users` collection, and now also `list` all subscriptions from the `/subscriptions` collection. No complex filtering is required in the rules.\n\nThis design promotes clear, maintainable security rules and supports atomic operations, enhancing data integrity and application scalability."
  }
}